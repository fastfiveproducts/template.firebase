
###################################################################
# User 

mutation CreateUser(
  $createDeviceIdentifierstamp: String!
  $createDeviceTimestamp: String!
  $displayNameText: String!
  $photoUrl: String!
) @auth(level: USER) {
  user_insert(
    data: {
        id_expr: "auth.uid"
        createDeviceIdentifierstamp: $createDeviceIdentifierstamp
        createDeviceTimestamp: $createDeviceTimestamp
        updateDeviceIdentifierstamp: ""
        updateDeviceTimestamp: ""
        displayNameText: $displayNameText
        photoUrl: $photoUrl
    }
  )
}

mutation UpdateUser(
  $updateDeviceIdentifierstamp: String!
  $updateDeviceTimestamp: String!
  $displayNameText: String!
  $photoUrl: String!
) @auth(level: USER) {
  user_update(id_expr: "auth.uid"
    data: {
        updateDeviceIdentifierstamp: $updateDeviceIdentifierstamp
        updateDeviceTimestamp: $updateDeviceTimestamp
        displayNameText: $displayNameText
        photoUrl: $photoUrl
    }
  )
}

mutation CreateUserDisplayName(
  $createDeviceIdentifierstamp: String!
  $createDeviceTimestamp: String!
  $displayNameText: String!
) @auth(level: USER)
  @transaction {

    # Step 1: Count existing display names for this user
    query
    @check(expr: "response.query.userDisplayNames.size() < 6", message: "you already have 5 previous display names, please use an old name") {
        userDisplayNames(
            where: { createUser: { id: { eq: "auth.uid" } } }
        ) {
            text_count
        }
    }

    # Step 2: Insert new display name
    userDisplayName_insert(
        data: {
            text: $displayNameText
            createUserId_expr: "auth.uid"
            createDeviceIdentifierstamp: $createDeviceIdentifierstamp
            createDeviceTimestamp: $createDeviceTimestamp
        }
    )
}


###################################################################
# User Demographic Profile
# A User Demographic Profile for a particular user can be changed
# by inserting a new row.

mutation CreateUserDemographicProfile(
    $createDeviceIdentifierstamp: String!
    $createDeviceTimestamp: String!
    $gender:   DemographicsGender_Key!
    $generation: DemographicsGeneration_Key!
    $region:   DemographicsRegion_Key!
    $urbanicity: DemographicsUrbanicity_Key!
    $political: DemographicsPolitical_Key!
) @auth(level: USER) {
  userDemographicProfile_insert(
    data: {
        createUserId_expr: "auth.uid"
        createDeviceIdentifierstamp: $createDeviceIdentifierstamp
        createDeviceTimestamp: $createDeviceTimestamp
        gender: $gender
        generation: $generation
        region: $region
        urbanicity: $urbanicity
        political: $political
    }
  )
}


###################################################################
# Cross-User Relationships
# User Relationships can be changed by inserting a new row.

mutation CreateUserAssociation(
    $associateUserId: String!
    $createDeviceIdentifierstamp: String!
    $createDeviceTimestamp: String!
    $follow: Boolean
    $block: Boolean
    $autoSharePrivateContent: Boolean
#) @auth(level: USER_EMAIL_VERIFIED) {
) @auth(level: USER) {
  userAssociation_insert(
    data: {
        createUserId_expr: "auth.uid"
        associateUserId: $associateUserId
        createDeviceIdentifierstamp: $createDeviceIdentifierstamp
        createDeviceTimestamp: $createDeviceTimestamp
        follow: $follow
        block: $block
        autoSharePrivateContent: $autoSharePrivateContent
    }
  )
}


###################################################################
# User Comments, User Messages

mutation CreatePublicComment(
    $toUserId: String!
    $toUserDisplayNameText: String!
    $createDeviceIdentifierstamp: String!
    $createDeviceTimestamp: String!
    $title: String!
    $content: String!
#) @auth(level: USER_EMAIL_VERIFIED) {
) @auth(level: USER) {
    publicComment_insert(
        data: {
            createUserId_expr: "auth.uid"
            toUserId: $toUserId
            toUserDisplayNameText: $toUserDisplayNameText
            createDeviceIdentifierstamp: $createDeviceIdentifierstamp
            createDeviceTimestamp: $createDeviceTimestamp
            title: $title
            content: $content
        }
    )
}

mutation CreatePrivateMessage(
    $toUserId: String!
    $toUserDisplayNameText: String!
    $createDeviceIdentifierstamp: String!
    $createDeviceTimestamp: String!
    $title: String!
    $content: String!
#) @auth(level: USER_EMAIL_VERIFIED) {
) @auth(level: USER) {
    privateMessage_insert(
        data: {
            createUserId_expr: "auth.uid"
            toUserId: $toUserId
            toUserDisplayNameText: $toUserDisplayNameText
            createDeviceIdentifierstamp: $createDeviceIdentifierstamp
            createDeviceTimestamp: $createDeviceTimestamp
            title: $title
            content: $content
        }
    )
}

mutation CreatePublicCommentReference(
    $publicCommentId: UUID!
    $referenceId: UUID!
#) @auth(level: USER_EMAIL_VERIFIED) {
) @auth(level: USER) {
    publicCommentReference_insert(
        data: {
            publicCommentId: $publicCommentId
            referenceId: $referenceId
            createUserId_expr: "auth.uid"
        }
    )
}

mutation CreatePrivateMessageReference(
    $privateMessageId: UUID!
    $referenceId: UUID!
#) @auth(level: USER_EMAIL_VERIFIED) {
) @auth(level: USER) {
    privateMessageReference_insert(
        data: {
            privateMessageId: $privateMessageId
            referenceId: $referenceId
            createUserId_expr: "auth.uid"
        }
    )
}

mutation CreatePrivateMessageStatus(
    $privateMessageId: UUID!
    $status: String!
#) @auth(level: USER_EMAIL_VERIFIED) {
) @auth(level: USER) {
    privateMessageStatus_insert(
        data: {
            privateMessageId: $privateMessageId
            createUserId_expr: "auth.uid"
            status: $status
        }
    )
}
