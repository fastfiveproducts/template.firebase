#
#  queries.gql
#
#  Created by Pete Maiser, Fast Five Products LLC.
#      Template v0.2.x — Fast Five Products LLC's public AGPL template.
#
#  Copyright © 2025, 2026 Fast Five Products LLC. All rights reserved.
#
#  This file is part of a project licensed under the GNU Affero General Public License v3.0.
#  See the LICENSE file at the root of this repository for full terms.
#
#  An exception applies: Fast Five Products LLC retains the right to use this code and
#  derivative works in proprietary software without being subject to the AGPL terms.
#  See LICENSE-EXCEPTIONS.md for details.
#
#  For licensing inquiries, contact: licenses@fastfiveproducts.llc
#

###################################################################
# Current User

query GetMyUserAccount @auth(
    level: USER
) {
    userAccounts(
        where: { id: { eq_expr: "auth.uid" } }
        orderBy: { createTimestamp: DESC }
        limit: 1
    ) {
        id
        displayNameText
        photoUrl
    }
}

query GetMyDisplayNames @auth(
    level: USER
) {
    userDisplayNames(
        where: { createUserId: { eq_expr: "auth.uid" } }
        orderBy: { setTimestamp: DESC }
        limit: 10
    ) {
        text
        createTimestamp
        setTimestamp
    }
}


###################################################################
# User Demographic Profile
# A User Demographic Profile for a particular user can be changed
# by inserting a new row.

query GetMyUserDemographicProfile @auth(
    level: USER
) {
    userDemographicProfiles(
        where: { createUserId: { eq_expr: "auth.uid" } }
        orderBy: { createTimestamp: DESC }
        limit: 1
    ) {
        createTimestamp
        gender {
            key
            name
            description
            photoUrl
        }
        generation {
            key
            name
            description
            birthYearStart
            birthYearEnd
            photoUrl
        }
        region {
            key
            name
            description
            photoUrl
        }
        urbanicity {
            key
            name
            description
            photoUrl
        }
        political {
            key
            name
            description
            photoUrl
        }
    }
}


###################################################################
# Cross-User Relationships
# User Relationships can be changed by inserting a new row.

query GetMyUserAssociations(
    $limit: Int!
) @auth(
    level: USER_EMAIL_VERIFIED
) {
    userAssociations (
        where: { createUserId: { eq_expr: "auth.uid" } }
        orderBy: [
            { createTimestamp: DESC }
            { associateUserId: ASC }
        ]
        limit: $limit
    ){
        associateUserId
        associateUserDisplayNameText
        createTimestamp
        follow
        block
        autoSharePrivateContent
    }
}


###################################################################
# General User 

query GetUserAccount(
    $userId: String!
) @auth(
    level: USER_EMAIL_VERIFIED
    insecureReason: "some user profile details are meant to be visible to all authenticated users"
) {
    userAccounts(
        where: { id: { eq: $userId } }
        orderBy: { createTimestamp: DESC }
        limit: 1
    ) {
        id
        displayNameText
        photoUrl
    }
}

query UserDisplayNameSearch(
    $searchText: String!
    $limit: Int!
) @auth(
    level: USER_EMAIL_VERIFIED
    insecureReason: "user search is needed for messaging functionality"
) {
    userAccounts(
        where: { displayNameTextLower: { contains: $searchText } }
        orderBy: { displayNameText: ASC }
        limit: $limit
    ) {
        id
        displayNameText
        photoUrl
    }
}


###################################################################
# User Comments, User Messages

query ListPublicComments(
    $appClientKey: String!
    $limit: Int!
) @auth(
    level: USER_ANON
    insecureReason: "public comments are meant to be visible to all authenticated users (including anonymous)"
) {
    publicComments(
        where: { appClientKey: { eq: $appClientKey } }
        orderBy: { createTimestamp: DESC }
        limit: $limit
    ) {
        id
        createTimestamp
        createUser {
            id
            displayNameText
            photoUrl
        }
        toUserId
        toUserDisplayNameText
        title
        content
    }
}

query GetMyPrivateMessages(
    $appClientKey: String!
    $limit: Int!
) @auth(
    level: USER_EMAIL_VERIFIED
) {
    privateMessages(
        where: {
            _and: [
                { appClientKey: { eq: $appClientKey } }
                {
                    _or: [
                        { createUserId: { eq_expr: "auth.uid" } }
                        { toUserId: { eq_expr: "auth.uid" } }
                    ]
                }
            ] }
        orderBy: { createTimestamp: DESC }
        limit: $limit
    ) {
        id
        createTimestamp
        createUser {
            id
            displayNameText
            photoUrl
        }
        toUserId
        toUserDisplayNameText
        title
        content
    }
}

query GetPublicCommentReferences(
    $commentId: UUID!
    $limit: Int!
) @auth(
    level: USER_ANON
    insecureReason: "public comments are meant to be visible to all authenticated users (including anonymous)"
) {
    publicCommentReferences(
        where: { publicCommentId: { eq: $commentId } }
        orderBy: [
            { publicComment: { createTimestamp: DESC } }
            { createTimestamp: DESC }
        ]
        limit: $limit
    ) {
        publicCommentId
        referenceId
    }
}

query GetMyPrivateMessageReferences(
    $limit: Int!
) @auth(
    level: USER_EMAIL_VERIFIED
) {
  privateMessageReferences(
    where: {
        privateMessage: {
            _or: [
                    { createUserId: { eq_expr: "auth.uid" } }
                    { toUserId: { eq_expr: "auth.uid" } }
                ] }
        }
        orderBy: [
            { privateMessage: { createTimestamp: DESC } }
            { createTimestamp: DESC }
        ]
        limit: $limit
    ) {
        privateMessageId
        referenceId
    }
}

query GetPrivateMessageReferences(
    $messageId: UUID!
    $limit: Int!
) @auth(
    level: USER_EMAIL_VERIFIED
) {
  privateMessageReferences(
    where: {
        privateMessage: {
            _and: [
                { id: { eq: $messageId } }
                {
                    _or: [
                        { createUserId: { eq_expr: "auth.uid" } }
                        { toUserId: { eq_expr: "auth.uid" } }
                    ]
                }
            ] }
        }
        orderBy: {createTimestamp: DESC}
        limit: $limit
    ) {
        privateMessageId
        referenceId
    }
}

query GetMyPrivateMessageStatus(
    $limit: Int!
) @auth(
    level: USER_EMAIL_VERIFIED
) {
  privateMessageStatuses(
    where: {
        privateMessage: {
            _or: [
                    { createUserId: { eq_expr: "auth.uid" } }
                    { toUserId: { eq_expr: "auth.uid" } }
                ] }
        }
        orderBy: [
            { privateMessage: { createTimestamp: DESC } }
            { createTimestamp: DESC }
        ]
        limit: $limit
    ) {
        privateMessageId
        createUserId
        createTimestamp
        status
    }
}

query GetPrivateMessageStatus(
    $messageId: UUID!
    $limit: Int!
) @auth(
    level: USER_EMAIL_VERIFIED
    insecureReason: "users need to see status of messages they received (created by others)"
) {
  privateMessageStatuses(
    where: {
        privateMessage: {
            _and: [
                { id: { eq: $messageId } }
                {
                    _or: [
                        { createUserId: { eq_expr: "auth.uid" } }
                        { toUserId: { eq_expr: "auth.uid" } }
                    ]
                }
            ]
        }
    }
    orderBy: { createTimestamp: DESC }
    limit: $limit
    ) {
        createUserId
        createTimestamp
        status
    }
}


###################################################################
# Demographic Values

query ListDemographicsGender @auth(
    level: USER
    insecureReason: "demographics are meant to be visible to all authenticated users"
) {
    demographicsGenders(
        orderBy: { key: ASC }
    ) {
        key
        name
        description
        photoUrl
    }
}

query ListDemographicsGeneration @auth(
    level: USER
    insecureReason: "demographics are meant to be visible to all authenticated users"
) {
    demographicsGenerations(
        orderBy: { key: ASC }
    ) {
        key
        name
        description
        birthYearStart
        birthYearEnd
        photoUrl
    }
}

query ListDemographicsRegion @auth(
    level: USER
    insecureReason: "demographics are meant to be visible to all authenticated users"
) {
    demographicsRegions(
        orderBy: { key: ASC }
    ) {
        key
        name
        description
        photoUrl
    }
}

query ListDemographicsUrbanicity @auth(
    level: USER
    insecureReason: "demographics are meant to be visible to all authenticated users"
) {
    demographicsUrbanicities(
        orderBy: { key: ASC }
    ) {
        key
        name
        description
        photoUrl
    }
}

query ListDemographicsPolitical @auth(
    level: USER
    insecureReason: "demographics are meant to be visible to all authenticated users"
) {
    demographicsPoliticals(
        orderBy: { key: ASC }
    ) {
        key
        name
        description
        photoUrl
    }
}


###################################################################
# RestrictedWord
query ListRestrictedWords(
    $limit: Int!
) @auth(
    level: USER_ANON
    insecureReason: "restricted words are reference data; any authenticated user (including anonymous) can read"
) {
    restrictedWords(
        orderBy: { word: ASC }
        limit: $limit
    ) {
        word
    }
}


###################################################################
# HelpText
query ListHelpText(
    $limit: Int!
) @auth(
    level: PUBLIC
    insecureReason: "help text is static, user-facing content"
) {
    helpTexts(
        orderBy: { code: ASC }
        limit: $limit
    ) {
        code
        text
    }
}


###################################################################
# FeatureFlag
query ListFeatureFlags(
    $appClientKey: String!
    $limit: Int!
) @auth(
    level: PUBLIC
    insecureReason: "feature flags are static configuration data"
) {
    featureFlags(
        where: { appClientKey: { eq: $appClientKey } }
        orderBy: { code: ASC }
        limit: $limit
    ) {
        code
        enabled
    }
}